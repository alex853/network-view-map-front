<!DOCTYPE html>
<html lang="en">

<head>
    <title>simforge.net - Network View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.min.js" type="text/javascript"></script>
    <script src="mappa.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
</head>

<body style="padding: 0; margin: 0;">
<script>

    let pilotPositions = [];

    let myMap;
    let canvas;
    const mappa = new Mappa('Leaflet');

    // Lets put all our map options in a single object
    const options = {
        lat: 0,
        lng: 0,
        zoom: 4,
        //style: "http://{s}.tile.osm.org/{z}/{x}/{y}.png"
        style: "http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"
    }

    function setup() {
        canvas = createCanvas(windowWidth, windowHeight);

        myMap = mappa.tileMap(options);
        myMap.overlay(canvas, function () {
            myMap.map.invalidateSize();
        });

        myMap.onChange(drawEverything);
    }

    // function draw() {
    //     drawEverything();
    // }

    function drawEverything() {
        console.info("drawEverything");

        clear();

/*        // Every Frame, get the canvas position
        // for the latitude and longitude of Nigeria
        const nigeria = myMap.latLngToPixel(11.396396, 5.076543);
        // Using that position, draw an ellipse
        ellipse(nigeria.x, nigeria.y, 20, 20);


        translate(50, 50);
        stroke(255, 0, 0);
        beginShape();
// Exterior part of shape, clockwise winding
        vertex(-40, -40);
        vertex(40, -40);
        vertex(40, 40);
        vertex(-40, 40);
// Interior part of shape, counter-clockwise winding
        beginContour();
        vertex(-20, -20);
        vertex(-20, 20);
        vertex(20, 20);
        vertex(20, -20);
        endContour();
        endShape(CLOSE);*/

        fill(200);
        let textHeight = 11;
        textSize(textHeight);

        pilotPositions.forEach(function (pilotPosition) {
            const coords = myMap.latLngToPixel(pilotPosition.latitude, pilotPosition.longitude);
            ellipse(coords.x, coords.y, 5, 5);

            text(pilotPosition.callsign, coords.x + 5, coords.y + textHeight/3);
        });
    }

    function mousePressed() {
        ellipse(mouseX, mouseY, 5, 5);
        // prevent default
        return false;
    }

    // https://github.com/cvalenzuela/Mappa/issues/31
    function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        myMap.resize(canvas);
    }

    function reload() {
        $.ajax({
            // url: "data.json",
            url: "http://localhost:8080/service/v1/status?network=IVAO",
            // url: "http://simforge.net:8080/tracker/rest/service/map/status?network=IVAO",
            method: "GET",
            dataType: "json",
            success: function (response) {
                pilotPositions = response.pilotPositions;
                drawEverything();
                setTimeout(function () { reload(); }, 30000);
            }
        });
    }

    $(document).ready(function () {
        reload();
    })

</script>
</body>

</html>